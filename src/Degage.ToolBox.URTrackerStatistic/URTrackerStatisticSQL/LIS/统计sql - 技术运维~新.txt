declare  @sdate  datetime
declare  @edate   datetime 
set @sdate='2019-01-01 00:00:01'
set @edate='2019-02-01 00:00:00'

-----提单总数----------

SELECT CreateUser,AssignTo,ProblemID,StateID,DateCreated 
,Title,content 
INTO #temp_Records
FROM Pts_Records a(nolock) WHERE a.DateCreated = (SELECT min(b.DateCreated) FROM Pts_Records b(NOLOCK), Pts_ProblemState c(nolock)  WHERE c.ProblemStateID=b.StateID AND c.StateName='已分配' and a.ProblemID=b.ProblemID )
AND a.StateID IN (SELECT d.ProblemStateID FROM Pts_ProblemState d (nolock) WHERE d.StateName='已分配') 
and a.DateCreated >= @sdate AND a.DateCreated <@edate

select d.name AS 项目名称, a.ProblemID as ID,a.CreateTime AS 提单时间, e.DateCreated as 处理时间,c.DisplayName as 转单人,f.DeptName as 转单人所在部门,h.DisplayName as 接单人,i.TypeName 类型,g.DeptName as 接单人所在部门,a.Title AS 标题,e.Title as 记录标题,e.content as 记录描述,
t.StateName AS 状态
into #xqzs
  from Pts_Problems a ,Accounts_Users  c,Pts_Projects d,#temp_Records e,Accounts_Department f ,Accounts_Users h ,Accounts_Department g,Pts_ProblemState t
   ,Pts_ProblemType i
where  
 e.CreateUser=c.UserID
AND c.DeptID=f.DeptID
AND e.AssignTo=h.UserID
AND h.DeptID=g.DeptID
AND a.ProjectID=d.ProjectID
 AND a.ProblemID=e.ProblemID
  AND a.OriginProjectID=i.ProjectID and a.ProblemTypeID=i.ProblemTypeID
 --AND c.DisplayName<>h.DisplayName
 AND d.ProjectID IN ('32','33','40','45','52','56')
 AND e.StateID=t.ProblemStateID

ORDER BY a.ProblemID;

DROP TABLE #temp_Records;


-------本月已完成-------------
select  a.ProblemID as ID,convert(varchar(10),a.CreateTime,120) AS 提单时间, 
e.DateCreated as 处理时间,c.DisplayName as 转单人,f.DeptName as 转单人所在部门,h.DisplayName as 接单人,g.DeptName as 接单人所在部门,a.select1 as 医院,
a.Title AS 标题,a.BigText1 AS 描述,e.title AS 转单标题 ,e.content AS 转单内容,
d.name AS 项目名称,j.statename AS 状态,a.Float1 as 工作量H,
convert(varchar(10),a.Deadline,120) 期限
into  #byywc
  from Pts_Problems a ,Accounts_Users  c,Pts_Projects d,Pts_Records e,Accounts_Department f ,Accounts_Users h ,
Accounts_Department g,pts_problemstate j
where  
 e.CreateUser=c.UserID
and e.StateID=j.ProblemStateID
AND c.DeptID=f.DeptID
AND e.AssignTo=h.UserID
AND h.DeptID=g.DeptID
AND a.ProjectID=d.ProjectID
 AND a.ProblemID=e.ProblemID
 AND h.DisplayName<>'董雪娟'
 AND c.DisplayName<>h.DisplayName
 AND g.DeptID=1
 and  j.statename='已完成待测试'
 and f.DeptName in ('技术支持一部','运维一部')
 AND f.DeptID IN (1,2,4,5,9,10,11,12,13,14,15,16,17,18,19,20,21,22)
AND e.DateCreated  >@sdate and e.DateCreated <@edate
ORDER BY a.ProblemID;


-------------------------------变更 统计--------------------------------------
select d.name AS 项目名称, a.ProblemID as ID,a.CreateTime AS 提单时间, e.DateCreated as 处理时间,c.DisplayName as 转单人,f.DeptName as 转单人所在部门,
h.DisplayName as 接单人,g.DeptName as 接单人所在部门,
a.Title AS 标题,e.title 转单标题 ,e.content 转单内容,j.statename 状态
into #bg
  from Pts_Problems a ,Accounts_Users  c,Pts_Projects d,Pts_Records e,Accounts_Department f ,Accounts_Users h ,Accounts_Department g,pts_problemstate j
where  
 e.CreateUser=c.UserID
and e.StateID=j.ProblemStateID
AND c.DeptID=f.DeptID
AND e.AssignTo=h.UserID
AND h.DeptID=g.DeptID
AND a.ProjectID=d.ProjectID
AND a.ProblemID=e.ProblemID
AND c.DisplayName<>h.DisplayName
AND a.ProjectID IN ('32','33','40','45','52','56')
AND j.StateName in ('已变更' ,'申请变更')
AND e.DateCreated  >@sdate and e.DateCreated <@edate
ORDER BY a.ProblemID;



select  * from  #xqzs
select  * from  #byywc
select  * from  #bg


--drop  table #xqzs
--drop  table #byywc
--drop  table  #bg
